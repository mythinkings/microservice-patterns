# 模式：每个服务的数据库

## 语境

假设您正在使用微服务[架构模式](https://microservices.io/patterns/microservices.html)开发在线商店应用程序。大多数服务都需要将数据持久保存在某种数据库中。例如，`Order Service`有关订单的`Customer Service`商店信息和有关客户的商店信息。

![img](https://microservices.io/i/customersandorders.png)

## 问题

微服务应用程序中的数据库架构是什么？

## 势力

- 服务必须松散耦合，以便可以独立开发，部署和扩展
- 一些业务交易必须强制执行跨越多个服务的不变式。例如，`Place Order`用例必须验证新订单不会超过客户的信用额度。其他业务交易，必须更新多个服务拥有的数据。
- 一些业务交易需要查询多个服务拥有的数据。例如，`View Available Credit`用户必须查询客户以查找`creditLimit`和订单，以计算未结订单的总金额。
- 某些查询必须联接多个服务拥有的数据。例如，要查找特定区域中的客户及其最近的订单，需要在客户和订单之间建立连接。
- 有时必须复制数据库并对其进行分片以进行扩展。参见[比例尺立方体](https://microservices.io/articles/scalecube.html)。
- 不同的服务有不同的数据存储要求。对于某些服务，关系数据库是最佳选择。其他服务可能需要NoSQL数据库，例如MongoDB，后者擅长存储复杂的非结构化数据，或Neo4J，Neo4J用于高效地存储和查询图形数据。

## 解决方案

保持每个微服务的持久性数据对该服务的私有性，并且只能通过其API进行访问。下图显示了此模式的结构。

![img](https://microservices.io/i/databaseperservice.png)

服务的数据库实际上是该服务的实现的一部分。其他服务无法直接访问它。

有几种不同的方法可以使服务的持久性数据保持私有。您无需为每个服务配置数据库服务器。例如，如果您使用的是关系数据库，则选项为：

- 每个服务专用表–每个服务拥有一组表，这些表只能由该服务访问
- 每个服务的架构–每个服务都有一个对该服务私有的数据库架构
- 每个服务的数据库服务器–每个服务都有自己的数据库服务器。

每个服务专用表和每个服务架构的开销最低。为每个服务使用模式很吸引人，因为它使所有权更清晰。一些高吞吐量服务可能需要它们自己的数据库服务器。

创建强制实施此模块化的障碍是一个好主意。例如，您可以为每个服务分配一个不同的数据库用户ID，并使用数据库访问控制机制（例如Grants）。在没有任何强制执行封装的障碍的情况下，开发人员总是很想绕过服务的API并直接访问其数据。

## 结果上下文

为每个服务使用数据库有以下好处：

- 帮助确保服务松散耦合。对一项服务的数据库所做的更改不会影响任何其他服务。
- 每个服务都可以使用最适合其需求的数据库类型。例如，进行文本搜索的服务可以使用ElasticSearch。操纵社交图的服务可以使用Neo4j。

每个服务使用数据库有以下缺点：

- 实现跨越多种服务的业务交易并非易事。由于CAP定理，最好避免分布式事务。而且，许多现代（NoSQL）数据库都不支持它们。最好的解决方案是使用[最终一致的，事件驱动的体系结构](https://microservices.io/patterns/cn/data/event-driven-architecture.html)。服务在更新数据时发布事件。其他服务订阅事件并作为响应更新其数据。
- 实现将现在多个数据库中的数据联接起来的查询具有挑战性。有多种解决方案：
- 应用程序侧连接-应用程序执行连接而不是数据库。例如，服务（或API网关）可以通过首先从客户服务中检索客户，然后查询订单服务以返回客户的最新订单来检索客户及其订单。
- 命令查询责任隔离（CQRS）-维护一个或多个实例化视图，其中包含来自多个服务的数据。这些视图由订阅每个服务在更新数据时发布的事件的服务保存。例如，在线商店可以通过维护连接客户和订单的视图来实施查询，以查找特定区域中的客户及其最近的订单。该视图由订阅客户和订单事件的服务更新。
- 管理多个SQL和NoSQL数据库的复杂性

## 相关模式

- [微服务架构模式](https://microservices.io/patterns/microservices.html)创造了对此模式的需求
- [事件驱动的架构模式](https://microservices.io/patterns/cn/data/event-driven-architecture.html)是实现最终一致事务的一种有用方法
- 该[命令查询职责隔离（CQRS）模式](https://microservices.io/patterns/cn/data/cqrs.html)是实现复杂查询的有效途径
- 在[共享数据库反模式](https://microservices.io/patterns/cn/data/shared-database.html)描述了从微服务共享数据库产生的问题