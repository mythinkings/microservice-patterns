# 模式：无服务器部署

## 语境

您已经应用了微服务[架构模式，](https://microservices.io/patterns/microservices.html)并将系统架构为一组服务。每个服务都被部署为一组服务实例，以提高吞吐量和可用性。

## 背景

服务如何打包和部署？

## 需求(Forces)

- 服务使用多种语言，框架和框架版本编写
- 每个服务都包含多个服务实例，以提高吞吐量和可用性
- 服务必须可独立部署和扩展
- 服务实例需要彼此隔离
- 您需要能够快速构建和部署服务
- 您需要能够限制服务消耗的资源（CPU和内存）
- 您需要监视每个服务实例的行为
- 您希望部署可靠
- 您必须尽可能经济高效地部署应用程序

## 解

使用隐藏任何服务器概念（即，预留或预分配的资源）-物理或虚拟主机或容器的部署基础结构。基础结构获取服务的代码并运行它。您将根据消耗的资源为每个请求付费。

要使用此方法部署服务，请打包代码（例如，将其打包为ZIP文件），然后将其上载到部署基础结构并描述所需的性能特征。

部署基础架构是由公共云提供商运营的实用程序。它通常使用容器或虚拟机来隔离服务。但是，这些详细信息对您而言是隐藏的。您和组织中的任何人都不负责管理任何底层基础结构，例如操作系统，虚拟机等。

## 例子

有几种不同的无服务器部署环境：

- [AWS Lambda](https://aws.amazon.com/lambda/)
- [Google Cloud功能](https://cloud.google.com/functions/docs)
- [Azure功能](https://azure.microsoft.com/en-us/services/functions/)

它们提供类似的功能，但AWS Lambda具有最丰富的功能集。AWS Lambda函数是被调用以处理事件的无状态组件。要创建一个AWS Lambda函数，您需要将您的服务的NodeJS，Java或Python代码打包在一个ZIP文件中，然后将其上传到AWS Lambda。您还可以指定处理事件的函数名称以及资源限制。

发生事件时，AWS Lambda会找到函数的一个空闲实例，如果没有可用实例，则启动一个实例并调用处理程序函数。AWS Lambda运行您的函数的足够实例来处理负载。在幕后，它使用容器来隔离lambda函数的每个实例。如您所料，AWS Lambda在EC2实例上运行容器。

有四种方法可以调用lambda函数。一种选择是将lambda函数配置为响应由AWS服务（例如S3，DynamoDB或Kinesis）生成的事件而被调用。事件示例包括：

- 在S3存储桶中创建的对象
- 在DynamoDB表中创建，更新或删除项目
- 可从Kinesis流中读取一条消息
- 通过简单电子邮件服务收到的电子邮件。

调用lambda函数的另一种方法是配置AWS Lambda网关以将HTTP请求路由到您的lambda。AWS Gateway将HTTP请求转换为事件对象，调用lambda函数，并根据lambda函数的结果生成HTTP响应。

您还可以使用AWS Lambda Web Service API显式调用lambda函数。调用lambda函数的应用程序将提供一个JSON对象，该对象将传递给lambda函数。Web服务调用返回lambda返回的值。

调用lambda函数的第四种方法是定期使用类似cron的机制。例如，您可以告诉AWS每隔五分钟调用一次lambda函数。

每次调用的成本是调用持续时间的函数（以100毫秒为增量进行度量），并消耗内存。

## 结果上下文

使用无服务器部署的好处包括：

- 它消除了花时间在无差别地繁重地管理底层基础结构上的时间。相反，您可以专注于代码。
- 无服务器部署基础架构非常灵活。它会自动扩展您的服务以处理负载。
- 您为每个请求付费，而不是提供可能未充分利用的虚拟机或容器。

无服务器部署的缺点包括：

- 显着的限制和约束-无服务器部署环境通常比基于VM或基于Container的基础结构具有更多的约束。例如，AWS Lambda仅支持几种语言。它仅适用于部署响应请求而运行的无状态应用程序。您不能部署长时间运行的有状态应用程序，例如数据库或消息代理。
- 有限的“输入源”-lambda只能响应来自有限输入源集的请求。AWS Lambda并非旨在运行例如订阅了消息代理的服务，例如RabbitMQ。
- 应用程序必须快速启动-无服务器部署不太适合您的服务，启动时间很长
- 高延迟的风险-基础结构配置您的功能实例和功能初始化所花费的时间可能会导致大量延迟。而且，无服务器部署基础架构只能对负载增加做出反应。您无法主动预配置容量。因此，当负载突然突然出现峰值时，您的应用程序最初可能会表现出高延迟。

部署基础结构将使用其他模式之一在内部部署应用程序。它最有可能使用“[每个主机”服务模式](https://microservices.io/patterns/cn/deployment/single-service-per-host.html)。

## 相关模式

- 在[每个主图案多个服务实例](https://microservices.io/patterns/cn/deployment/multiple-services-per-host.html)是一种替代部署解决方案
- 在[每台主机的单一服务模式](https://microservices.io/patterns/cn/deployment/single-service-per-host.html)是一种替代部署解决方案